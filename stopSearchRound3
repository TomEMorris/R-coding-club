if (!require(rgdal)){
  install.packages("rgdal")
  library(rgdal)
}

if (!require(RColorBrewer)){
  install.package
  library(RColorBrewer)
}

if (!require(leaflet)){
  install.packages("leaflet")
  library(leaflet)
}

setwd("~/Health_R_coding_club")

unzip("Police_Force_Areas_December_2016_Ultra_Generalised_Clipped_Boundaries_in_England_and_Wales.zip", exdir = "~/Health_R_coding_club")

StopSearch <- read.csv("stop-and-search.csv")

policeForce_map_shp <- readOGR("Police_Force_Areas_December_2016_Ultra_Generalised_Clipped_Boundaries_in_England_and_Wales.shp", layer = "Police_Force_Areas_December_2016_Ultra_Generalised_Clipped_Boundaries_in_England_and_Wales", GDAL1_integer64_policy = TRUE)

policeForce_map_shp <- spTransform(policeForce_map_shp, CRS("+proj=longlat +ellps=GRS80"))

#Lets focus on a ethnicity
StopSearchBlack <- subset(StopSearch, Ethnicity == "Black" & Time=="2017/18", select = c(Geography, Rate.per.1.000.population.by.ethnicity))

levels_map <- merge(policeForce_map_shp, StopSearchBlack, by.x = "pfa16nm", by.y="Geography")

bins <- c(0, 5, 15, 20, 25, 30, 35, 40, 45, 50, Inf)
pal <- colorBin("BuPu", domain = levels_map$`Rate per 1,000 population by ethnicity`, bins = bins)


#pal = colorFactor(colours, domain = levels_map$`Rate per 1,000 population by ethnicity`)

labels <- sprintf(
  "<strong>Area: %s</strong><br/>Rate: %s",
  levels_map$pfa16nm, ss_map$`Rate per 1,000 population by ethnicity`
) %>% lapply(htmltools::HTML)


leaflet(data = levels_map) %>%
  addPolygons(fillColor = ~pal(`Rate per 1,000 population by ethnicity`),
              weight = 2,
              opacity = 1,
              color = "white",
              dashArray = "3",
              fillOpacity = 0.7,
              highlight = highlightOptions(
                weight = 5,
                color = "#666",
                dashArray = "",
                fillOpacity = 0.7,
                bringToFront = TRUE),
              label = labels) %>%
              addLegend(pal = pal, values = ~`Rate per 1,000 population by ethnicity`, opacity = 0.7, title = NULL,
                        position = "bottomright")

